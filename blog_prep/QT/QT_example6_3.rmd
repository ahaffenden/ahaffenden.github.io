---
title: "echan_ex6.3: Calculating the Optimal Allocation Using Kelly Formula
author: "Austin Haffenden"
date: '`r Sys.Date()`'
output: 
  md_document:
    variant: markdown_github
---

```{r setup, include=FALSE}
```
## Calculating the Optimal Allocation Using Kelly Formula

We pick three sector-specific ETFs and see how we should allocate capital among
them to achieve the maximum growth rate for the portfolio.

The three ETFs are: OIH (oil service), RKH (regional bank), and RTH (retail). 
The daily prices are downloaded from Yahoo! Finance and saved in
epchan.com/book as OIH.xls, RKH.xls, and RTH.xls. 

This file calculates M, C, and F* (F* = C^-1*M), where:
  M is the column vector of mean returns for the strategies;
  C is the covariance matrix such that Cij is the covariance of returns of the
  ith and jth strategies;
  F is the kelly optimal leverages
  
  This is taken from exercise 6.3 of E.Chans book Quantitative Trading. 

```{r cl_libs, message=FALSE}
rm(list = ls()) # clear the workspace
library(dplyr)
```

```{r data_in}

# OIH data
oih_in <- read.csv(file.path("data", "OIH.csv"))

# the first column (starting from the second row) is the trading days in
# format mm-dd-yyyy.
tday_oih <- oih_in$Date

# convert the format into yyyymmdd.
tday_oih <- format(as.Date(tday_oih, "%d-%m-%Y"), "%Y%m%d")

# convert the date strings first into cell arrays and then into numeric format.
tday_oih <- as.numeric(as.character(tday_oih)) 

# the last column contains the adjusted close prices.
cls_oih <- oih_in$Adj.Close

# RKH data 
rkh_in <- read.csv(file.path("data", "RKH.csv"))

# the first column (starting from the second row) is the trading days in
# format mm/dd/yyyy.
tday_rkh <- rkh_in$Date

# convert the format into yyyymmdd.
tday_rkh <- format(as.Date(tday_rkh, "%d-%m-%Y"), "%Y%m%d")

# convert the date strings first into cell arrays and then into numeric format.
tday_rkh <- as.numeric(as.character(tday_rkh)) 

# the last column contains the adjusted close prices.
cls_rkh <- rkh_in$Adj.Close

# RTH data
rth_in <- read.csv(file.path("data", "RTH.csv"))

# the first column (starting from the second row) is the trading days in
# format mm/dd/yyyy.
tday_rth <- rth_in$Date

# convert the format into yyyymmdd.
tday_rth <- format(as.Date(tday_rth, "%d-%m-%Y"), "%Y%m%d")

# convert the date strings first into cell arrays and then into numeric format.
tday_rth <- as.numeric(as.character(tday_rth)) 

# the last column contains the adjusted close prices.
cls_rth <- rth_in$Adj.Close

```

```{r }
# merge these data - tday is the same as octave: tested
tday <- union(tday_oih, tday_rkh)
tday <- union(tday, tday_rth)

adjcls <- matrix(NaN, length(tday), 3)

int_oih <- dplyr::intersect(tday_oih, tday)
idx_oih <- match(tday_oih, tday)

adjcls[idx_oih] <- cls_oih[idx_oih]


idx <- match(tday_rkh, int_oih_rkh)
                 
[foo idx1 idx]=intersect;
adjcls(idx, 1)=adjcls1(idx1);

# rows for rkh
[foo idx2 idx]=intersect(tday2, tday);
adjcls(idx, 2)=adjcls2(idx2);

# rows for idx
[foo idx3 idx]=intersect(tday3, tday);
adjcls(idx, 3)=adjcls3(idx3);
```

```{r calcs}
ret=(adjcls-lag1(adjcls))./lag1(adjcls); % returns

baddata=find(any(~isfinite(ret), 2)); % days where any one return is missing

ret(baddata, :)=[]; % eliminate days where any one return is missing

excessRet=ret-repmat(0.04/252, size(ret)); % excess returns: assume annualized risk free rate is 4%

M=252*mean(excessRet, 1)' % annualized mean excess returns
% M =
% 
%     0.1396
%     0.0294
%    -0.0073

C=252*cov(excessRet) % annualized covariance matrix
% C =
% 
%     0.1109    0.0200    0.0183
%     0.0200    0.0372    0.0269
%     0.0183    0.0269    0.0420

F=inv(C)*M % Kelly optimal leverages
% F =
% 
%     1.2919
%     1.1723
%    -1.4882

g=0.04+F'*C*F/2 % Maximum annualized compounded growth rate
% g =
% 
%     0.1529

S=sqrt(F'*C*F) % Sharpe ratio of portfolio
% S =
% 
%     0.4751
```
