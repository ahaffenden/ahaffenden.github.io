---
title: "echan_ex6.3: Calculating the Optimal Allocation Using Kelly Formula
author: "Austin Haffenden"
date: '`r Sys.Date()`'
output: 
  md_document:
    variant: markdown_github
---

```{r setup, include=FALSE}
```
## Calculating the Optimal Allocation Using Kelly Formula

We pick three sector-specific ETFs and see how we should allocate capital among
them to achieve the maximum growth rate for the portfolio.

The three ETFs are: OIH (oil service), RKH (regional bank), and RTH (retail). 
The daily prices are downloaded from Yahoo! Finance and saved in
epchan.com/book as OIH.xls, RKH.xls, and RTH.xls. 

This file calculates M, C, and F* (F* = C^-1*M), where:
  M is the column vector of mean returns for the strategies;
  C is the covariance matrix such that Cij is the covariance of returns of the
  ith and jth strategies;
  F is the kelly optimal leverages
  
  This is taken from exercise 6.3 of E.Chans book Quantitative Trading. 

```{r cl_libs, message=FALSE}
rm(list = ls()) # clear the workspace
library(dplyr)
```

```{r data_in}

# OIH data
oih_in <- read.csv(file.path("data", "OIH.csv"))

# the first column (starting from the second row) is the trading days in
# format mm-dd-yyyy.
tday1 <- oih_in$Date

# convert the format into yyyymmdd.
tday1 <- format(as.Date(tday1, "%d-%m-%Y"), "%Y%m%d")

# convert the date strings first into cell arrays and then into numeric format.
tday1 <- rev(as.numeric(as.character(tday1)))

# the last column contains the adjusted close prices.
adjcls1 <- oih_in$Adj.Close

# RKH data 
rkh_in <- read.csv(file.path("data", "RKH.csv"))

# the first column (starting from the second row) is the trading days in
# format mm/dd/yyyy.
tday2 <- rkh_in$Date

# convert the format into yyyymmdd.
tday2 <- format(as.Date(tday2, "%d-%m-%Y"), "%Y%m%d")

# convert the date strings first into cell arrays and then into numeric format.
tday2 <- as.numeric(as.character(tday2)) 

# the last column contains the adjusted close prices.
adjcls2 <- rkh_in$Adj.Close

# RTH data
rth_in <- read.csv(file.path("data", "RTH.csv"))

# the first column (starting from the second row) is the trading days in
# format mm/dd/yyyy.
tday3 <- rth_in$Date

# convert the format into yyyymmdd.
tday3 <- format(as.Date(tday3, "%d-%m-%Y"), "%Y%m%d")

# convert the date strings first into cell arrays and then into numeric format.
tday3 <- as.numeric(as.character(tday3)) 

# the last column contains the adjusted close prices.
adjcls3 <- rth_in$Adj.Close

```

```{r }
# merge these data - tday is the same as octave: tested
tday <- union(tday1, tday2)
tday <- union(tday, tday3)

adjcls <- matrix(NaN, length(tday), 3)

#========================================
# tday1
foo <- dplyr::intersect(tday1, tday)

# idx1 is the indices of tday1
idx1 <- tday1 %in% foo 

# idx is the indices of tday
idx <- tday %in% foo

adjcls[idx, 1] <- adjcls1[idx1]

#========================================
# tday2
foo <- dplyr::intersect(tday2, tday)

# idx1 is the indices of tday2
idx2 <- tday2 %in% foo 

# idx is the indices of tday
idx <- tday %in% foo

adjcls[idx, 2] <- adjcls2[idx2]

head(adjcls)
tail(adjcls)
#========================================
# tday3
foo <- dplyr::intersect(tday3, tday)

# idx1 is the indices of tday3
idx3 <- tday3 %in% foo 

# idx is the indices of tday
idx <- tday %in% foo

adjcls[idx, 3] <- adjcls3[idx3]

head(adjcls, 60)
tail(adjcls)

```

```{r calcs}
ret=(adjcls-lag1(adjcls))./lag1(adjcls); % returns

baddata=find(any(~isfinite(ret), 2)); % days where any one return is missing

ret(baddata, :)=[]; % eliminate days where any one return is missing

excessRet=ret-repmat(0.04/252, size(ret)); % excess returns: assume annualized risk free rate is 4%

M=252*mean(excessRet, 1)' % annualized mean excess returns
% M =
% 
%     0.1396
%     0.0294
%    -0.0073

C=252*cov(excessRet) % annualized covariance matrix
% C =
% 
%     0.1109    0.0200    0.0183
%     0.0200    0.0372    0.0269
%     0.0183    0.0269    0.0420

F=inv(C)*M % Kelly optimal leverages
% F =
% 
%     1.2919
%     1.1723
%    -1.4882

g=0.04+F'*C*F/2 % Maximum annualized compounded growth rate
% g =
% 
%     0.1529

S=sqrt(F'*C*F) % Sharpe ratio of portfolio
% S =
% 
%     0.4751
```
